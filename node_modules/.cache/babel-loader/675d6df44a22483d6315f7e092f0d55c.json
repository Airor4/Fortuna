{"ast":null,"code":"var _jsxFileName = \"/Users/Airor/Desktop/Fortuna/Fortuna/fortuna/src/casus/CasusEditor.js\";\nimport * as React from 'react';\nimport CasusBlock from './blocks/CasusBlock.js';\nimport OrBlock from './blocks/OrBlock.js';\nimport VariableBlock from './blocks/VariableBlock.js';\nimport IntEqualsBlock from './blocks/IntEqualsBlock.js';\nimport SetVariableBlock from './blocks/SetVariableBlock.js';\nimport ForBlock from './blocks/ForBlock.js';\nimport ContainerBlock from './blocks/ContainerBlock.js';\nimport EmptyBlock from './blocks/EmptyBlock.js';\nimport Vec from './blocks/Vec.js';\nimport './CasusEditor.css';\nconst RIGHT_BUTTON_CODE = 2;\n\nclass CasusEditor extends React.Component {\n  constructor(props) {\n    super(props);\n    const orBlock = new OrBlock();\n    const orBlock2 = new OrBlock();\n    const testVariable = new VariableBlock('DOUBLE', 'Some variable with a really long name');\n    const testEquals = new IntEqualsBlock();\n    const setIntVariable = new SetVariableBlock('answer', 'INT');\n    const testForLoop = new ForBlock();\n    const containerBlock = new ContainerBlock([]);\n    orBlock.lChild = orBlock2;\n    containerBlock.children.push(orBlock);\n    containerBlock.children.push(testVariable);\n    containerBlock.children.push(testEquals);\n    containerBlock.children.push(setIntVariable);\n    containerBlock.children.push(testForLoop);\n    this.state = {\n      containerBlock: containerBlock,\n      mouseX: 0,\n      mouseY: 0,\n      mouseOnScreen: false\n    };\n  }\n\n  componentDidMount() {\n    window.addEventListener('resize', () => this._rerender());\n    const canvas = this.refs.canvas;\n\n    canvas.onmousemove = e => this.onMouseMove(e);\n\n    canvas.onmouseout = () => this.onMouseOut();\n\n    canvas.onmouseup = () => this.onMouseUp();\n\n    canvas.onmousedown = e => this.onMouseDown(e);\n\n    canvas.oncontextmenu = e => {\n      e.preventDefault();\n    };\n\n    this._rerender();\n  }\n\n  render() {\n    return React.createElement(\"div\", {\n      className: \"casusEditorContainingDiv\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 84\n      },\n      __self: this\n    }, React.createElement(\"canvas\", {\n      className: \"casusEditorCanvas\",\n      ref: \"canvas\",\n      __source: {\n        fileName: _jsxFileName,\n        lineNumber: 85\n      },\n      __self: this\n    }));\n  }\n\n  onMouseMove(e) {\n    const canvas = this.refs.canvas;\n    const boundingBox = canvas.getBoundingClientRect();\n    this.setState({\n      mouseX: e.clientX - boundingBox.left,\n      mouseY: e.clientY - boundingBox.top,\n      mouseOnScreen: true\n    });\n\n    this._rerender();\n  }\n\n  onMouseOut() {\n    this.setState({\n      mouseOnScreen: false\n    });\n\n    this._rerender();\n  }\n\n  onMouseUp() {\n    const wouldPlaceOnEmptyVoid = this._wouldPlaceOnEmptyVoid();\n\n    this._tryToPlace(null);\n\n    if (!wouldPlaceOnEmptyVoid) {\n      this._tryToPlaceInContainerBlock(null);\n    }\n\n    this.props.onDraggedBlocksReleased();\n\n    this._rerender();\n  }\n\n  onMouseDown(e) {\n    const canvas = this.refs.canvas;\n    const boundingBox = canvas.getBoundingClientRect();\n    const eventPos = new Vec(e.clientX - boundingBox.left, e.clientY - boundingBox.top);\n    const rightButton = e.button === RIGHT_BUTTON_CODE;\n    let toSelect = [];\n\n    if (rightButton) {\n      toSelect = this.state.containerBlock.removeBlockAt(eventPos, true);\n    } else {\n      toSelect = this.state.containerBlock.removeBlockAt(eventPos, false);\n    }\n\n    if (toSelect.length > 0) {\n      this.props.onBlocksDragged(toSelect);\n    }\n\n    this._rerender();\n  }\n\n  _rerender() {\n    const canvas = this.refs.canvas;\n    const ctx = canvas.getContext('2d');\n\n    this._resizeCanvas();\n\n    this._clearBackground(ctx);\n\n    const containerBlock = this.state.containerBlock;\n    containerBlock.precompBounds();\n    containerBlock.precompXY(0, 0);\n    containerBlock.renderDFS(ctx); //deal with highlights\n\n    this.state.containerBlock.unhighlightEverything();\n\n    const wouldPlaceOnEmptyVoid = this._wouldPlaceOnEmptyVoid();\n\n    if (this.state.mouseOnScreen) {\n      this._tryToPlace(ctx);\n    }\n\n    if (!wouldPlaceOnEmptyVoid) {\n      this._tryToPlaceInContainerBlock(ctx);\n    }\n\n    containerBlock.highlightDFS(ctx);\n\n    if (this.state.mouseOnScreen && this.props.draggedBlocks != null) {\n      const oldAlpha = ctx.globalAlpha;\n      ctx.globalAlpha = 0.5;\n      const containerBlock = new ContainerBlock(this.props.draggedBlocks);\n      containerBlock.precompBounds();\n      containerBlock.precompXY(this.state.mouseX, this.state.mouseY);\n      containerBlock.renderDFS(ctx);\n      ctx.globalAlpha = oldAlpha;\n    }\n  }\n\n  _clearBackground(ctx) {\n    //fill background\n    ctx.fillStyle = 'white';\n    ctx.fillRect(0, 0, 100000, 100000);\n  }\n\n  _resizeCanvas() {\n    const canvas = this.refs.canvas;\n\n    if (canvas.width !== canvas.clientWidth || canvas.height !== canvas.clientHeight) {\n      canvas.width = canvas.clientWidth;\n      canvas.height = canvas.clientHeight;\n    }\n  } //checks if a realeased block would be placed on an empty block with void return type\n\n\n  _wouldPlaceOnEmptyVoid() {\n    if (this.props.draggedBlocks != null) {\n      const mousePos = new Vec(this.state.mouseX, this.state.mouseY);\n      const deepest = this.state.containerBlock.getDeepestChildContainingPoint(mousePos);\n\n      if (deepest instanceof EmptyBlock && deepest.getReturnType() === 'VOID') {\n        return true;\n      }\n    }\n\n    return false;\n  }\n\n  _tryToPlace(ctx) {\n    if (this.props.draggedBlocks != null) {\n      const mousePos = new Vec(this.state.mouseX, this.state.mouseY);\n      const blockToTryPlace = this.props.draggedBlocks.length === 1 ? this.props.draggedBlocks[0] : new ContainerBlock(this.props.draggedBlocks);\n      blockToTryPlace.precompBounds();\n      blockToTryPlace.precompXY(mousePos.x, mousePos.y);\n      this.state.containerBlock.tryToPlace(mousePos, blockToTryPlace, ctx);\n    }\n  }\n\n  _tryToPlaceInContainerBlock(ctx) {\n    if (this.props.draggedBlocks != null) {\n      const mousePos = new Vec(this.state.mouseX, this.state.mouseY);\n      const blockToTryPlace = this.props.draggedBlocks.length === 1 ? this.props.draggedBlocks[0] : new ContainerBlock(this.props.draggedBlocks);\n\n      if (blockToTryPlace.getReturnType() !== 'VOID') {\n        return;\n      }\n\n      blockToTryPlace.precompBounds();\n      this.state.containerBlock.tryToPlaceInContainer(mousePos, blockToTryPlace, ctx);\n    }\n  }\n\n}\n\nexport default CasusEditor;","map":{"version":3,"sources":["/Users/Airor/Desktop/Fortuna/Fortuna/fortuna/src/casus/CasusEditor.js"],"names":["React","CasusBlock","OrBlock","VariableBlock","IntEqualsBlock","SetVariableBlock","ForBlock","ContainerBlock","EmptyBlock","Vec","RIGHT_BUTTON_CODE","CasusEditor","Component","constructor","props","orBlock","orBlock2","testVariable","testEquals","setIntVariable","testForLoop","containerBlock","lChild","children","push","state","mouseX","mouseY","mouseOnScreen","componentDidMount","window","addEventListener","_rerender","canvas","refs","onmousemove","e","onMouseMove","onmouseout","onMouseOut","onmouseup","onMouseUp","onmousedown","onMouseDown","oncontextmenu","preventDefault","render","boundingBox","getBoundingClientRect","setState","clientX","left","clientY","top","wouldPlaceOnEmptyVoid","_wouldPlaceOnEmptyVoid","_tryToPlace","_tryToPlaceInContainerBlock","onDraggedBlocksReleased","eventPos","rightButton","button","toSelect","removeBlockAt","length","onBlocksDragged","ctx","getContext","_resizeCanvas","_clearBackground","precompBounds","precompXY","renderDFS","unhighlightEverything","highlightDFS","draggedBlocks","oldAlpha","globalAlpha","fillStyle","fillRect","width","clientWidth","height","clientHeight","mousePos","deepest","getDeepestChildContainingPoint","getReturnType","blockToTryPlace","x","y","tryToPlace","tryToPlaceInContainer"],"mappings":"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","sourcesContent":["//@flow strict\n\nimport * as React from 'react';\nimport CasusBlock from './blocks/CasusBlock.js';\nimport OrBlock from './blocks/OrBlock.js';\nimport VariableBlock from './blocks/VariableBlock.js';\nimport IntEqualsBlock from './blocks/IntEqualsBlock.js';\nimport SetVariableBlock from './blocks/SetVariableBlock.js';\nimport ForBlock from './blocks/ForBlock.js';\nimport ContainerBlock from './blocks/ContainerBlock.js';\nimport EmptyBlock from './blocks/EmptyBlock.js';\nimport Vec from './blocks/Vec.js';\nimport './CasusEditor.css';\n\ntype Props = {|\n\tdraggedBlocks: ?Array<CasusBlock>,\n\tonDraggedBlocksReleased: () => void,\n\tonBlocksDragged: (Array<CasusBlock>) => void\n|};\n\ntype State = {|\n\tcontainerBlock: CasusBlock,\n\tmouseX: number,\n\tmouseY: number,\n\tmouseOnScreen: boolean\n|};\n\ntype MouseEvent = {\n\tclientX: number,\n\tclientY: number,\n\tbutton: ?number\n}\n\ntype CanPreventDefaultEvent = {\n\tpreventDefault: () => void;\n}\n\nconst RIGHT_BUTTON_CODE=2;\n\nclass CasusEditor extends React.Component<Props, State> {\n\n\tconstructor(props: Props) {\n\t\tsuper(props);\n\n\t\tconst orBlock: OrBlock = new OrBlock();\n\t\tconst orBlock2: CasusBlock = new OrBlock();\n\t\tconst testVariable: CasusBlock = new VariableBlock('DOUBLE', 'Some variable with a really long name');\n\t\tconst testEquals: IntEqualsBlock = new IntEqualsBlock();\n\t\tconst setIntVariable: CasusBlock = new SetVariableBlock('answer', 'INT');\n\t\tconst testForLoop: CasusBlock = new ForBlock();\n\n\t\tconst containerBlock: ContainerBlock = new ContainerBlock([]);\n\n\t\torBlock.lChild = orBlock2;\n\n\t\tcontainerBlock.children.push(orBlock);\n\t\tcontainerBlock.children.push(testVariable);\n\t\tcontainerBlock.children.push(testEquals);\n\t\tcontainerBlock.children.push(setIntVariable);\n\t\tcontainerBlock.children.push(testForLoop);\n\n\t\tthis.state={\n\t\t\tcontainerBlock: containerBlock,\n\t\t\tmouseX: 0,\n\t\t\tmouseY: 0,\n\t\t\tmouseOnScreen: false\n\t\t}\n\t}\n\n\tcomponentDidMount(): void {\n\t\twindow.addEventListener('resize', () => this._rerender());\n\t\tconst canvas: HTMLCanvasElement = this.refs.canvas;\n\t\tcanvas.onmousemove = (e: MouseEvent) => this.onMouseMove(e);\n\t\tcanvas.onmouseout = () => this.onMouseOut();\n\t\tcanvas.onmouseup = () => this.onMouseUp();\n\t\tcanvas.onmousedown = (e: MouseEvent) => this.onMouseDown(e);\n\t\tcanvas.oncontextmenu = (e: CanPreventDefaultEvent) => {e.preventDefault();};\n\n\t\tthis._rerender();\n\t}\n\n\trender(): React.Node {\n\t\treturn (\n\t\t\t<div className=\"casusEditorContainingDiv\">\n\t\t\t\t<canvas \n\t\t\t\t\tclassName=\"casusEditorCanvas\"\n\t\t\t\t\tref=\"canvas\" \n\t\t\t\t/>\n\t\t\t</div>\n\t\t);\n\t}\n\n\tonMouseMove(e: MouseEvent): void {\n\t\tconst canvas: HTMLCanvasElement = this.refs.canvas;\n\t\tconst boundingBox: ClientRect = canvas.getBoundingClientRect();\n\t\tthis.setState({\n\t\t\tmouseX: e.clientX - boundingBox.left,\n\t\t\tmouseY: e.clientY - boundingBox.top,\n\t\t\tmouseOnScreen: true\n\t\t});\n\n\t\tthis._rerender();\n\t}\n\n\tonMouseOut(): void {\n\t\tthis.setState({mouseOnScreen: false});\n\t\tthis._rerender();\n\t}\n\n\tonMouseUp(): void {\n\t\tconst wouldPlaceOnEmptyVoid = this._wouldPlaceOnEmptyVoid();\n\t\tthis._tryToPlace(null);\n\t\tif (!wouldPlaceOnEmptyVoid) {\n\t\t\tthis._tryToPlaceInContainerBlock(null);\n\t\t}\n\t\tthis.props.onDraggedBlocksReleased();\n\t\tthis._rerender();\n\t}\n\n\tonMouseDown(e: MouseEvent) {\n\t\tconst canvas: HTMLCanvasElement = this.refs.canvas;\n\t\tconst boundingBox: ClientRect = canvas.getBoundingClientRect();\n\n\t\tconst eventPos=new Vec(e.clientX - boundingBox.left, e.clientY - boundingBox.top);\n\t\tconst rightButton = e.button === RIGHT_BUTTON_CODE;\n\t\t\n\t\tlet toSelect: Array<CasusBlock> = [];\n\t\tif (rightButton) {\n\t\t\ttoSelect = this.state.containerBlock.removeBlockAt(eventPos, true);\n\t\t}\n\t\telse {\n\t\t\ttoSelect = this.state.containerBlock.removeBlockAt(eventPos, false);\n\t\t}\n\t\tif (toSelect.length > 0) {\n\t\t\tthis.props.onBlocksDragged(toSelect);\n\t\t}\n\n\t\tthis._rerender();\n\t}\n\n\t_rerender(): void {\n\t\tconst canvas: HTMLCanvasElement = this.refs.canvas;\n\t\tconst ctx: CanvasRenderingContext2D = canvas.getContext('2d');\n\n\t\tthis._resizeCanvas();\n\t\tthis._clearBackground(ctx);\n\n\t\tconst containerBlock=this.state.containerBlock;\n\t\tcontainerBlock.precompBounds();\n\t\tcontainerBlock.precompXY(0, 0);\n\t\tcontainerBlock.renderDFS(ctx);\n\n\t\t//deal with highlights\n\t\tthis.state.containerBlock.unhighlightEverything();\n\t\tconst wouldPlaceOnEmptyVoid = this._wouldPlaceOnEmptyVoid();\n\t\tif (this.state.mouseOnScreen) {\n\t\t\tthis._tryToPlace(ctx);\n\t\t}\n\t\tif (!wouldPlaceOnEmptyVoid) {\n\t\t\tthis._tryToPlaceInContainerBlock(ctx);\n\t\t}\n\t\tcontainerBlock.highlightDFS(ctx);\n\n\t\tif (this.state.mouseOnScreen && this.props.draggedBlocks != null) {\n\t\t\tconst oldAlpha=ctx.globalAlpha;\n\t\t\tctx.globalAlpha=0.5;\n\t\n\t\t\tconst containerBlock=new ContainerBlock(this.props.draggedBlocks);\n\t\t\tcontainerBlock.precompBounds();\n\t\t\tcontainerBlock.precompXY(this.state.mouseX, this.state.mouseY);\n\t\t\tcontainerBlock.renderDFS(ctx);\n\n\t\t\tctx.globalAlpha=oldAlpha;\n\t\t}\n\t}\n\n\t_clearBackground(ctx: CanvasRenderingContext2D): void {\n\t\t//fill background\n\t\tctx.fillStyle = 'white';\n\t\tctx.fillRect(0, 0, 100000, 100000);\n\t}\n\n\t_resizeCanvas(): void {\n\t\tconst canvas: HTMLCanvasElement = this.refs.canvas;\n\t\tif (canvas.width !== canvas.clientWidth || canvas.height !==canvas.clientHeight) {\n\t\t\tcanvas.width=canvas.clientWidth;\n\t\t\tcanvas.height=canvas.clientHeight;\n\t\t}\n\t}\n\n\t//checks if a realeased block would be placed on an empty block with void return type\n\t_wouldPlaceOnEmptyVoid(): boolean {\n\t\tif (this.props.draggedBlocks != null) {\n\t\t\tconst mousePos = new Vec(this.state.mouseX, this.state.mouseY);\n\t\t\tconst deepest=this.state.containerBlock.getDeepestChildContainingPoint(mousePos);\n\t\t\tif ((deepest instanceof EmptyBlock) && deepest.getReturnType() === 'VOID') {\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\t_tryToPlace(ctx: ?CanvasRenderingContext2D) {\n\t\tif (this.props.draggedBlocks != null) {\n\t\t\tconst mousePos = new Vec(this.state.mouseX, this.state.mouseY);\n\t\t\tconst blockToTryPlace = this.props.draggedBlocks.length === 1 ? \n\t\t\t\tthis.props.draggedBlocks[0] :\n\t\t\t\tnew ContainerBlock(this.props.draggedBlocks);\n\t\t\tblockToTryPlace.precompBounds();\n\t\t\tblockToTryPlace.precompXY(mousePos.x, mousePos.y);\n\n\t\t\tthis.state.containerBlock.tryToPlace(mousePos, blockToTryPlace, ctx);\n\t\t}\n\t}\n\n\t_tryToPlaceInContainerBlock(ctx: ?CanvasRenderingContext2D) {\n\t\tif (this.props.draggedBlocks != null) {\n\t\t\tconst mousePos = new Vec(this.state.mouseX, this.state.mouseY);\n\t\t\tconst blockToTryPlace = this.props.draggedBlocks.length === 1 ? \n\t\t\t\tthis.props.draggedBlocks[0] :\n\t\t\t\tnew ContainerBlock(this.props.draggedBlocks);\n\t\t\tif (blockToTryPlace.getReturnType() !== 'VOID') {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tblockToTryPlace.precompBounds();\n\n\t\t\tthis.state.containerBlock.tryToPlaceInContainer(mousePos, blockToTryPlace, ctx);\t\n\t\t}\n\t}\n\n}\n\nexport default CasusEditor;\n\n"]},"metadata":{},"sourceType":"module"}